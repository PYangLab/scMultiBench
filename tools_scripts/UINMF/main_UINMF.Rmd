
library(rhdf5)
library(scran)
library(Seurat)
library(rliger)
library(HDF5Array)
source("util.R")

run_UINMF <- function(file_paths,save_path){
  begin_time <- Sys.time()
  processed_data <- read_h5_data(file_paths$rna_path,file_paths$adt_path,file_paths$atac_path,length(file_paths[[1]]))
  UINMF_input <- UINMF_input_function(file_paths, processed_data)

  osm.UINMF <- createLiger(UINMF_input) 
  osm.UINMF <- rliger::normalize(osm.UINMF)
  
  dataset_list <- list()
  for (i in 1:(length(file_paths[[1]]))) { dataset_list[[i]] <- i }
  
  osm.UINMF <- selectGenes(osm.UINMF, useUnsharedDatasets=1, unsharedThresh = 0.4)
  osm.UINMF <- scaleNotCenter(osm.UINMF)
  osm.UINMF <- runIntegration(osm.UINMF, k = 30, method = "UINMF")
  
  result <- osm.UINMF@H.norm
  end_time <- Sys.time()
  all_time <- difftime(end_time, begin_time, units="secs")
  
  if (!dir.exists(save_path)) {
    dir.create(save_path, recursive = TRUE)
    print("path create")
  }
  write_h5(exprs_list = list(rna = result), h5file_list = c(paste0(save_path,"embedding.h5")))
  write.csv(all_time, paste(save_path,"time.csv"))
}


